# Context Awareness - Operating Guide (Reference)

## Design goals

- **Stable entry point**: `docs/context/AGENTS.md` is the authoritative LLM routing entrypoint; `docs/context/INDEX.md` and `docs/context/registry.json` serve as supplementary context entry points.
- **Verifiable updates**: artifact checksums enable CI to detect edits that bypass the scripts.
- **Tool-agnostic artifacts**: OpenAPI, BPMN 2.0, and a normalized DB schema mapping.

## ctl-context responsibilities

`ctl-context` is a **registry management tool**:

- **Register**: add/remove artifacts to `docs/context/registry.json`
- **Checksum**: compute and update SHA-256 checksums via `touch`
- **Verify**: check file existence and checksum consistency

`ctl-context` does **NOT**:

- Execute shell commands or generators
- Auto-regenerate artifacts from source

## Contract mode vs Generated mode

### Contract mode (recommended default)

- The artifact file is the authoritative contract.
- Human collaborators and LLMs edit the file directly.
- After edits, run:
  - `node .ai/skills/features/context-awareness/scripts/ctl-context.mjs touch`
  - `node .ai/skills/features/context-awareness/scripts/ctl-context.mjs verify --strict`

### Generated mode (opt-in)

- The artifact file is generated by **external tools** (e.g., OpenAPI generators, Prisma, custom scripts).
- Register the artifact with `mode=generated`.
- Workflow:
  1. Run your external generator tool manually or via CI
  2. Run `ctl-context touch` to update checksums
  3. Run `ctl-context verify --strict` to confirm consistency

> **Note**: `ctl-context` does not provide auto-execution of generator commands.
> The `source.command` field in registry is for **documentation only**.

## Recommended CI gates

Minimum:

- `node .ai/skills/features/context-awareness/scripts/ctl-context.mjs verify --strict`
- `node .ai/scripts/ctl-project-state.mjs verify`

For generated mode artifacts, run your generators **before** the verify step.

## Common artifact types

- `openapi`: API surface contract (`docs/context/api/openapi.yaml`)
- `json` (api-index): LLM-friendly API overview (`docs/context/api/api-index.json`)
- `json` (glossary): domain term definitions (`docs/context/glossary.json`)
- `markdown` (architecture-principles): cross-cutting constraints (`docs/context/architecture-principles.md`)
- `db-schema`: normalized DB structure mapping (`docs/context/db/schema.json`)
- `bpmn`: BPMN 2.0 process file (`docs/context/process/*.bpmn`)

## Glossary management

After `docs/context/glossary.json` is materialized:

```bash
node .ai/skills/features/context-awareness/scripts/ctl-context.mjs add-term --term "tenant" --definition "An isolated customer organization" --scope global --aliases "organization,org" --see-also "workspace"
node .ai/skills/features/context-awareness/scripts/ctl-context.mjs remove-term --term "tenant"
node .ai/skills/features/context-awareness/scripts/ctl-context.mjs list-terms --format json
```

The `add-term` command performs case-insensitive dedup and auto-runs `touch`.

## Architecture principles management

Edit `docs/context/architecture-principles.md` directly. Mark superseded principles with `[SUPERSEDED by ...]` — do not delete them. After editing, run `ctl-context touch`.

## Glossary schema validation

Glossary validation automatically uses [Ajv](https://ajv.js.org/) for full JSON Schema draft-07 compliance when available. Without Ajv, a built-in subset validator runs as fallback. For full compliance:

```bash
pnpm add -D ajv ajv-formats
```

`--strict` means warnings are treated as errors — it does not require Ajv.

## Troubleshooting

- **Checksum mismatch**: you edited an artifact but did not run `ctl-context touch`.
- **Missing file**: registry references a path that does not exist; create the file or remove the registry entry via script.
