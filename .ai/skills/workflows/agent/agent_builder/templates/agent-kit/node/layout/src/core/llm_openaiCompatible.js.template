export function createOpenAICompatibleClient({ baseUrl, apiKey, model, timeoutMs }) {
  const root = String(baseUrl || '').replace(/\/+$/, '');
  const url = root + '/chat/completions';

  async function chat({ messages, tools, toolChoice, temperature, maxOutputTokens }) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs || 30000);

    try {
      const body = {
        model,
        messages,
      };

      if (typeof temperature === 'number') body.temperature = temperature;
      if (Number.isInteger(maxOutputTokens)) body.max_tokens = maxOutputTokens;
      if (tools && Array.isArray(tools) && tools.length > 0) body.tools = tools;
      if (toolChoice) body.tool_choice = toolChoice;

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          ...(apiKey ? { authorization: `Bearer ${apiKey}` } : {}),
        },
        body: JSON.stringify(body),
        signal: controller.signal,
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = null; }

      if (!res.ok) {
        const msg = json?.error?.message || text || `HTTP ${res.status}`;
        const err = new Error(msg);
        err.httpStatus = res.status;
        err.body = json || text;
        throw err;
      }

      return json;
    } finally {
      clearTimeout(t);
    }
  }

  return { chat };
}
