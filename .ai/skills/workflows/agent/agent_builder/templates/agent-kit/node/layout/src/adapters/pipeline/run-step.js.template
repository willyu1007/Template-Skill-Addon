import fs from 'fs';
import path from 'path';
import { runAgent } from '../../core/agent.js';
import { toErrorResponse } from '../../core/errors.js';

function parseArgs(argv) {
  const args = {};
  for (let i = 0; i < argv.length; i++) {
    const a = argv[i];
    if (a === '--input') args.input = argv[++i];
    else if (a === '--output') args.output = argv[++i];
  }
  return args;
}

function readStdin() {
  return new Promise((resolve, reject) => {
    let data = '';
    process.stdin.setEncoding('utf8');
    process.stdin.on('data', (chunk) => { data += chunk; });
    process.stdin.on('end', () => resolve(data));
    process.stdin.on('error', reject);
  });
}

function ensureDirForFile(p) {
  fs.mkdirSync(path.dirname(p), { recursive: true });
}

async function main() {
  const args = parseArgs(process.argv.slice(2));

  let raw;
  if (args.input) {
    raw = fs.readFileSync(args.input, 'utf8');
  } else {
    raw = await readStdin();
  }

  let req;
  try { req = JSON.parse(raw); } catch (e) {
    throw Object.assign(new Error('Invalid JSON input.'), { code: 'INVALID_INPUT_JSON' });
  }

  const output = await runAgent(req, { requestId: 'pipe_' + Date.now() });
  const outText = JSON.stringify(output);

  if (args.output) {
    ensureDirForFile(args.output);
    fs.writeFileSync(args.output, outText);
  } else {
    process.stdout.write(outText + '\n');
  }
}

main().catch((err) => {
  const e = toErrorResponse(err);
  process.stderr.write(JSON.stringify(e) + '\n');
  process.exit(1);
});
