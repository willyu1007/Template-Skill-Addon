import http from 'http';
import { fileURLToPath } from 'url';
import { loadConfig, log } from '../../core/config.js';
import { runAgent } from '../../core/agent.js';
import { toErrorResponse } from '../../core/errors.js';

function readJsonBody(req) {
  return new Promise((resolve, reject) => {
    let data = '';
    req.on('data', (chunk) => { data += chunk; });
    req.on('end', () => {
      if (!data) return resolve({});
      try { resolve(JSON.parse(data)); } catch (e) { reject(e); }
    });
    req.on('error', reject);
  });
}

function normalizePath(p) {
  if (!p.startsWith('/')) return '/' + p;
  return p.replace(/\/+$/, '') || '/';
}

function withBase(basePath, routePath) {
  const b = normalizePath(basePath);
  const r = normalizePath(routePath);
  if (b === '/') return r;
  if (r === '/') return b;
  return b + r;
}

function respond(res, status, body) {
  const payload = JSON.stringify(body);
  res.writeHead(status, { 'content-type': 'application/json' });
  res.end(payload);
}

export function startServer() {
  const cfg = loadConfig();
  const basePath = cfg.basePath;

  const healthPath = withBase(basePath, '/health');
  const runPath = withBase(basePath, '/run');

  const server = http.createServer(async (req, res) => {
    const url = new URL(req.url || '/', `http://${req.headers.host || 'localhost'}`);
    const pathname = url.pathname;

    const requestId = req.headers['x-request-id'] || req.headers['x-correlation-id'] || undefined;

    if (req.method === 'GET' && pathname === healthPath) {
      return respond(res, 200, { status: 'ok', agent_id: cfg.agentId, ts: new Date().toISOString() });
    }

    if (req.method === 'POST' && pathname === runPath) {
      try {
        const body = await readJsonBody(req);
        const output = await runAgent(body, { requestId });
        return respond(res, 200, output);
      } catch (err) {
        const e = toErrorResponse(err);
        const status = e.code === 'AGENT_DISABLED' ? 503 : 500;
        log('error', { msg: 'api_run_error', requestId, error: e });
        return respond(res, status, e);
      }
    }

    return respond(res, 404, { code: 'NOT_FOUND', message: 'Route not found', details: { pathname } });
  });

  server.listen(cfg.port, () => {
    const address = server.address();
    const port = typeof address === 'object' && address ? address.port : cfg.port;
    log('info', { msg: 'api_listening', port, basePath: cfg.basePath });
  });

  return server;
}

// Auto-start only when executed directly (not when imported).
const __filename = fileURLToPath(import.meta.url);
if (process.argv[1] === __filename) {
  startServer();
}
