import assert from 'assert';
import { startServer } from '../adapters/http/server.js';
import { runAgent } from '../core/agent.js';

async function testKillSwitch() {
  process.env.AGENT_ENABLED = 'false';
  let threw = false;
  try {
    await runAgent({ input: { text: 'hello' } }, { requestId: 'test_kill' });
  } catch (e) {
    threw = true;
    assert.equal(e.code, 'AGENT_DISABLED');
  }
  assert.equal(threw, true);
}

async function testHealthEndpoint() {
  process.env.AGENT_ENABLED = 'false';
  process.env.AGENT_PORT = '0';
  process.env.AGENT_BASE_PATH = '/agent/test';
  const server = startServer();

  const address = server.address();
  const port = typeof address === 'object' && address ? address.port : 0;

  const res = await fetch(`http://127.0.0.1:${port}/agent/test/health`);
  assert.equal(res.status, 200);

  const body = await res.json();
  assert.equal(body.status, 'ok');

  await new Promise((r) => server.close(r));
}

async function main() {
  await testKillSwitch();
  await testHealthEndpoint();
  process.stdout.write('smoke tests passed\n');
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
