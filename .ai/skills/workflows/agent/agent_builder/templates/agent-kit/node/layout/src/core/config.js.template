import fs from 'fs';
import path from 'path';

function readJsonIfExists(p) {
  try {
    if (!fs.existsSync(p)) return null;
    return JSON.parse(fs.readFileSync(p, 'utf8'));
  } catch {
    return null;
  }
}

export function loadConfig() {
  // Non-secret defaults can be placed in config/default.json
  const configPath = process.env.AGENT_CONFIG_FILE || path.join(process.cwd(), 'config', 'default.json');
  const fileCfg = readJsonIfExists(configPath) || {};

  const cfg = {
    agentId: '__AGENT_ID__',
    agentName: '__AGENT_NAME__',
    enabled: (process.env.AGENT_ENABLED ?? 'true') === 'true',
    logLevel: process.env.AGENT_LOG_LEVEL || 'info',

    basePath: process.env.AGENT_BASE_PATH || '__AGENT_BASE_PATH__',
    port: Number(process.env.AGENT_PORT || 8080),

    llm: {
      baseUrl: process.env.LLM_BASE_URL || 'https://api.openai.com/v1',
      apiKey: process.env.LLM_API_KEY || '',
      model: process.env.LLM_MODEL || '__LLM_MODEL__',
      timeoutMs: Number(process.env.LLM_TIMEOUT_MS || fileCfg?.agent?.llm_timeout_ms || 30000),
      reasoningProfile: process.env.LLM_REASONING_PROFILE || '__LLM_REASONING_PROFILE__',
    },

    limits: {
      maxSteps: Number(process.env.AGENT_MAX_STEPS || fileCfg?.agent?.max_steps || 6),
    },

    worker: {
      inputDir: process.env.AGENT_WORKER_INPUT_DIR || 'var/worker/input',
      outputDir: process.env.AGENT_WORKER_OUTPUT_DIR || 'var/worker/output',
      pollIntervalMs: Number(process.env.AGENT_WORKER_POLL_INTERVAL_MS || fileCfg?.worker?.poll_interval_ms || 1000),
    },

    cron: {
      inputJsonEnv: process.env.AGENT_CRON_INPUT_JSON || '',
      inputFile: process.env.AGENT_CRON_INPUT_FILE || '',
      outputFile: process.env.AGENT_CRON_OUTPUT_FILE || '',
    }
  };

  return cfg;
}

export function log(level, obj) {
  const levels = ['debug','info','warn','error'];
  const cfgLevel = process.env.AGENT_LOG_LEVEL || 'info';
  if (levels.indexOf(level) < levels.indexOf(cfgLevel)) return;
  const line = JSON.stringify({ level, ts: new Date().toISOString(), ...obj });
  process.stdout.write(line + '\n');
}
