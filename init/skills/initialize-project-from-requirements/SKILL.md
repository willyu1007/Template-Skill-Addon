# Skill: initialize-project-from-requirements

The skill connects the end-to-end initialization flow:

`requirements docs -> project blueprint -> scaffold/config generation -> skills sync`

It records an auditable init state throughout the workflow so that each stage has an explicit **validate + user approval** checkpoint.

Goal: a robust, repeatable, rollback-friendly initialization workflow (not "fastest possible").

---

## Inputs

### Stage A (requirements docs, required)

Working location (default: `init/stage-a-docs/`):

- `init/stage-a-docs/requirements.md`
- `init/stage-a-docs/non-functional-requirements.md`
- `init/stage-a-docs/domain-glossary.md`
- `init/stage-a-docs/risk-open-questions.md`

### Stage B (blueprint, required)

Working location (default): `init/project-blueprint.json`

> After initialization completes, use `cleanup-init --archive` to move these files to `docs/project/` for long-term retention.

### Optional: features

Feature flags live under `blueprint.features`.

**No external payload directory is required.** Feature templates are integrated in this template under:

- `.ai/skills/features/<feature-id>/templates/` (some features source templates from nested skills; for database: `.ai/skills/features/database/sync-code-schema-from-db/templates/`)

Stage C `apply` materializes enabled features by copying templates into the repo (copy-if-missing by default) and then running the corresponding control scripts (Node under `.ai/scripts/` and/or Python under `.ai/skills/features/**/scripts/`, depending on the feature).

---

## Outputs (written to disk)

### Working files (during initialization)

- Stage A docs: `init/stage-a-docs/*`
- Blueprint: `init/project-blueprint.json`
- Init state file: `init/.init-state.json`

### Archived files (after `cleanup-init --archive`)

- Stage A docs: `docs/project/*`
- Blueprint: `docs/project/project-blueprint.json`
- Init state board: `docs/project/init-state.json`

### Stage C outputs

- Directory scaffold (examples):
  - `src/` or `apps/` + `packages/` (based on `repo.layout`)
  - `docs/diagrams/` (if diagram capability is enabled)
  - `ops/` (if DevOps scaffold is enabled)
- Config files generated by `scripts/scaffold-configs.cjs` (for example `.gitignore`, lint/test/format configs, depending on the blueprint)
- Root `README.md` may be generated from the blueprint when `scripts/templates/README.template.md` is present
- Skills selection (SSOT):
  - `.ai/skills/_meta/sync-manifest.json` (flat schema: `version/includePrefixes/includeSkills/excludeSkills`)
  - If `.ai/scripts/skillsctl.js` exists, pack toggles must be done via skillsctl
- Provider wrappers generated/updated:
  - `node .ai/scripts/sync-skills.cjs` (supports `--providers`)

### Optional feature outputs

Depending on `blueprint.features`, Stage C may also materialize:

- Context Awareness: `docs/context/**` + `config/environments/**` (and related context contracts)
- Database: `db/**` (when `db.ssot=database`) or `prisma/**` (when `db.ssot=repo-prisma`)
- UI: `ui/**` + `docs/context/ui/**`
- Environment: `env/**` + `docs/project/env-ssot.json` (and optionally generated `.env.example` + `docs/env.md`)
- Packaging: `ops/packaging/**` + `docs/packaging/registry.json`
- Deployment: `ops/deploy/**`
- Observability: `observability/**` + `docs/context/observability/**`
- Release: `release/**` + `.releaserc.json.template`

---

## Mandatory workflow rules

1. Every stage transition requires **validation + explicit user approval**.
   - Validation is recorded in `init/.init-state.json` by pipeline commands.
   - Stage advancement must use `approve` (do not hand-edit the state file to "skip" stages).
2. Do not advance stages without explicit user approval.
3. Features are materialized **on demand**:
   - Only `blueprint.features.*` triggers materialization.
   - `blueprint.context.*` is configuration only and does not trigger enabling by itself.
4. The manifest schema is the **flat schema** (do not use older nested shapes like `collections.current`).
5. Config generation has a single SSOT: `scripts/scaffold-configs.cjs`.
6. Do not create dev-docs task bundles during initialization; use dev-docs after init completes.

---

## Standard workflow (run from repo root)

All command paths in the document assume you run from the repo root.

### 0) Initialize state

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs start --repo-root .
```

### 1) Stage A: validate requirements docs -> user approval

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs check-docs \
  --repo-root . \
  --strict
```

Optional: update the must-ask checklist (for the state board; see the full key list in `init/skills/initialize-project-from-requirements/reference.md`):

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs mark-must-ask \
  --repo-root . \
  --key onePurpose \
  --asked \
  --answered \
  --written-to init/stage-a-docs/requirements.md
```

After the user reviews Stage A docs and explicitly says "approved", run:

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs approve --stage A --repo-root .
```

### 2) Stage B: validate blueprint -> user approval

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs validate \
  --repo-root .
```

Optional: record that packs were reviewed (for the state board):

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs review-packs --repo-root .
```

After the user reviews the blueprint and explicitly approves, run:

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs approve --stage B --repo-root .
```

### 3) Stage C: write scaffold/configs/packs/features/wrappers -> user approval

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs apply \
  --repo-root . \
  --providers both
```

Stage C `apply` may generate a project-specific root `README.md` from the blueprint via `scripts/templates/README.template.md`. If the file is generated, include `README.md` in the Stage C review.

Troubleshooting: if Stage C `apply` fails with `EPERM` when writing `.codex/skills/` or `.claude/skills/`, re-run the same `apply` command in an elevated shell. Do not change the blueprint between attempts.

After the user reviews the changes and explicitly approves, run:

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs approve --stage C --repo-root .
```

### 4) Post-init: skill retention and pruning (required)

After Stage C approval, generate and fill the skill retention table:

1) Ensure `init/skill-retention-table.template.md` exists (copy from the template if needed).
2) Fill the table with current skills from `.ai/skills/` (translate descriptions if needed).
3) Ask the user which skills to keep/delete (record TBD if undecided).
4) Preview deletions, then confirm and delete:

```bash
node .ai/scripts/delete-skills.cjs --dry-run --skills "<csv>"
node .ai/scripts/delete-skills.cjs --skills "<csv>" --yes
```

(`delete-skills.cjs` is an alias of `delete-skill.cjs`.)

### Optional: prune unused feature tooling (tests/scripts)

This template ships:

- Central feature-pack tests under `.ai/tests/` (not per-skill `tests/` folders)
- Feature controller scripts under `.ai/scripts/`

Initialization does **not** auto-delete these. If the user explicitly does not need the corresponding feature packs, you MAY remove the related paths (after confirmation), for example:

- DB mirror tooling: `.ai/scripts/dbctl.js`, `.ai/scripts/migrate.js`
- Deployment tooling: `.ai/scripts/deployctl.js`, `.ai/scripts/rollback.js`
- Packaging tooling: `.ai/scripts/packctl.js`
- Release tooling: `.ai/scripts/releasectl.js`
- Observability tooling: `.ai/scripts/obsctl.js`
- Feature-pack test suites: `.ai/tests/suites/database/`, `.ai/tests/suites/environment/`, `.ai/tests/suites/ui/`

After pruning, re-run wrapper sync:

```bash
node .ai/scripts/sync-skills.cjs --scope current --providers both --mode reset --yes
```

### 5) Post-init: update root README.md and AGENTS.md (recommended)

After Stage C approval, explicitly ask:

> Do you want to record the project type, tech stack, and key directories in the root `AGENTS.md`, and update the root `README.md`?

If approved, update and show a diff before writing.

### 6) Optional: remove the init kit

When the user confirms the bootstrap kit is no longer needed:

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.cjs cleanup-init \
  --repo-root . \
  --apply \
  --i-understand
```

---

## Context Awareness feature notes

### How the workflow is triggered

To trigger feature materialization/init, set:

- `blueprint.features.contextAwareness: true`

Optional (configuration only; does not trigger enabling):

- `blueprint.context.mode: "contract" | "snapshot"` (default: `contract`)

### Key scripts

- `.ai/scripts/contextctl.js`
  - `init`: initializes the `docs/context/` scaffold (idempotent)
- `.ai/scripts/projectctl.js`
  - `init`: initializes `.ai/project/state.json` (idempotent)
  - `set-context-mode <contract|snapshot>`: sets the context mode
- `.ai/scripts/skillsctl.js`
  - `enable-pack <packId> --no-sync`: enables a pack (writes manifest)

For full details, see `.ai/skills/features/context-awareness/`.
